{% extends 'base.html' %}
{% load static %}
{% block title %}Message | Sublime Caixa{% endblock %}

{% block dashboard %}

<div class="container">
    <br>
    <div class="card shadow-sm p-4 mb-4 bg-dark text-white">
        <h4 class="p-4 text-center mb-3">Personalizar Mensagens</h4>
        <div class="row g-2">
            <div class="col-md-3">
                <input type="text" id="template-titulo" class="form-control" placeholder="Título (ex: Confirmação)">
            </div>
            <div class="col-md-7">
                <textarea rows="1" type="text" id="template-conteudo" class="form-control" placeholder="Mensagem (use @nome, @data, @hora, @semana)"></textarea>
            </div>
            <div class="col-md-2">
                <input type="hidden" id="template-index" value="">
                <div class="d-flex">
                    <button id="btn-salvar-template" class="btn btn-success w-100 mr-1" onclick="salvarTemplate()">Salvar</button>
                    <button id="btn-cancelar-template" class="btn btn-danger" onclick="cancelarEdicao()" style="display: none;">✕</button>
                </div>
            </div>
        </div>
        <div class="mt-3">
            <ul id="lista-templates" class="list-group list-group-flush"></ul>
        </div>
    </div>

    <div class="card shadow-sm p-4 bg-dark text-white">
        <h4 class="p-4 text-center mb-4">Envio de Mensagens WhatsApp</h4>

        <table class="table table-dark table-striped align-middle">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Telefone</th>
                    <th>Data</th>
                    <th>Dia da semana</th>
                    <th>Hora</th>
                    <th>Mensagem</th>
                    <th>Ação</th>
                </tr>
            </thead>
            <tbody id="tabela-mensagens">
                <tr>
                    <td><input class="form-control nome" placeholder="Nome da cliente" maxlength="50"></td>
                    <td><input class="form-control telefone" placeholder="+351 123 456 789" maxlength="16"></td>
                    <td><input class="form-control data" placeholder="DD/MM" maxlength="5"></td>
                    <td><input class="form-control semana" placeholder="segunda-feira" maxlength="20"></td>
                    <td><input class="form-control hora" placeholder="HH:MM" maxlength="5"></td>
                    <td>
                        <select class="form-control mensagem-select">
                            <option value="">Selecione...</option>
                        </select>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-success enviar-btn mr-2">
                                Enviar
                            </button>
                            <button class="btn btn-sm text-danger limpar-btn" title="Limpar linha" style="font-size: 1.2rem;">✕</button>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>

        <button class="btn btn-secondary mt-3" onclick="adicionarLinha()">
            + Adicionar Linha
        </button>
    </div>
</div>

<script>

let templates = JSON.parse(localStorage.getItem('whatsapp_templates')) || [];

// Adiciona templates padrão se não existirem
if (templates.length === 0) {
    templates = [
        { title: "Confirmação Padrão", content: "Bom dia querida @nome, temos uma marcação para as unhas na @semana, dia @data às @hora, posso confirmar seu horário?" },
        { title: "Lembrete com Sinal", content: "Bom dia, @nome. Seu agendamento está marcado para @semana, dia @data, às @hora. Para confirmar, solicitamos o envio do sinal no valor de 10€. Caso não haja confirmação até hoje às 19h, o horário será automaticamente cancelado e disponibilizado para outras clientes. Fico a aguardar a sua confirmação" }
    ];
    localStorage.setItem('whatsapp_templates', JSON.stringify(templates));
}

function renderTemplates() {
    const lista = document.getElementById('lista-templates');
    lista.innerHTML = '';
    
    templates.forEach((t, index) => {
        lista.innerHTML += `
           <li class="list-group-item d-flex align-items-center bg-dark text-white border-secondary"
                style="max-width: 1100px; cursor: move;"
                draggable="true"
                ondragstart="dragStart(event, ${index})"
                ondragover="dragOver(event)"
                ondrop="drop(event, ${index})"
                ondragend="dragEnd(event)">

                <span style="
                    flex: 1;
                    min-width: 0;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                ">
                    <i class='bx bx-grid-vertical mr-2' style="color: #aaa;"></i>
                    <strong>${t.title}</strong>: ${t.content}
                </span>

                <div class="ms-3 flex-shrink-0">
                    <button class="btn btn-secondary btn-sm"
                            onclick="editarTemplate(${index})">
                        Editar
                    </button>

                    <button class="btn btn-sm btn-danger"
                            onclick="removerTemplate(${index})">
                        Excluir
                    </button>
                </div>

            </li>
        `;
    });

    // Atualiza todos os selects existentes na tabela
    const selects = document.querySelectorAll('.mensagem-select');
    selects.forEach(select => {
        const valAtual = select.value;
        select.innerHTML = getOptionsHtml();
        if (valAtual) select.value = valAtual;
    });
}

function salvarTemplate() {
    const titulo = document.getElementById('template-titulo').value;
    const conteudo = document.getElementById('template-conteudo').value;
    const index = document.getElementById('template-index').value;
    
    if (!titulo || !conteudo) return alert("Por favor, preencha título e conteúdo da mensagem!");
    
    if (index !== "") {
        // Edição
        templates[index] = { title: titulo, content: conteudo };
    } else {
        // Novo
        templates.push({ title: titulo, content: conteudo });
    }
    
    localStorage.setItem('whatsapp_templates', JSON.stringify(templates));
    
    cancelarEdicao(); // Limpa o formulário e reseta estado
    renderTemplates();
}

function editarTemplate(index) {
    const t = templates[index];
    document.getElementById('template-titulo').value = t.title;
    document.getElementById('template-conteudo').value = t.content;
    document.getElementById('template-index').value = index;
    
    const btnSalvar = document.getElementById('btn-salvar-template');
    btnSalvar.textContent = 'Atualizar';
    btnSalvar.classList.remove('btn-secondary');
    btnSalvar.classList.add('btn-success');
    
    document.getElementById('btn-cancelar-template').style.display = 'block';
}

function cancelarEdicao() {
    document.getElementById('template-titulo').value = '';
    document.getElementById('template-conteudo').value = '';
    document.getElementById('template-index').value = '';
    
    const btnSalvar = document.getElementById('btn-salvar-template');
    btnSalvar.textContent = 'Salvar';
    btnSalvar.classList.add('btn-secondary');
    btnSalvar.classList.remove('btn-success');
    
    document.getElementById('btn-cancelar-template').style.display = 'none';
}

function removerTemplate(index) {
    const t = templates[index];
    if (confirm(`Tem certeza que deseja excluir a mensagem "${t.title}"?`)) {
        templates.splice(index, 1);
        localStorage.setItem('whatsapp_templates', JSON.stringify(templates));
        renderTemplates();
    }
}

function getOptionsHtml() {
    let html = '<option value="">Selecione...</option>';
    templates.forEach(t => {
        // Escape simples para aspas no value
        const contentSafe = t.content.replace(/"/g, '&quot;');
        html += `<option value="${contentSafe}">${t.title}</option>`;
    });
    return html;
}

document.addEventListener('DOMContentLoaded', renderTemplates);

function adicionarLinha() {
    const tabela = document.getElementById('tabela-mensagens');

    const novaLinha = `
    <tr>
        <td><input class="form-control nome" placeholder="Nome da cliente" maxlength="50"></td>
        <td><input class="form-control telefone" placeholder="+351 123 456 789" maxlength="16"></td>
        <td><input class="form-control data" placeholder="DD/MM" maxlength="5"></td>
        <td><input class="form-control semana" placeholder="segunda-feira" maxlength="20"></td>
        <td><input class="form-control hora" placeholder="HH:MM" maxlength="5"></td>
        <td>
            <select class="form-control mensagem-select">
                ${getOptionsHtml()}
            </select>
        </td>
        <td>
            <div class="d-flex align-items-center">
                <button class="btn btn-success enviar-btn mr-2">
                    Enviar
                </button>
                <button class="btn btn-sm text-danger limpar-btn" title="Limpar linha" style="font-size: 1.2rem;">✕</button>
            </div>
        </td>
    </tr>
    `;

    tabela.insertAdjacentHTML('beforeend', novaLinha);
}

// Delegação de evento para todos os botões
document.addEventListener('click', function(e) {

    if (e.target.classList.contains('enviar-btn')) {

        const linha = e.target.closest('tr');

        const nome = linha.querySelector('.nome').value;
        const telefone = linha.querySelector('.telefone').value.replace(/\D/g,'');
        const data = linha.querySelector('.data').value;
        const semana = linha.querySelector('.semana').value;
        const hora = linha.querySelector('.hora').value;
        const mensagemTemplate = linha.querySelector('.mensagem-select').value;

        if (telefone.length < 10) {
            alert('Número inválido, por favor, insira um número com DDI +351 e 9 dígitos.');
            return;
        }

        if (!nome) {
            alert('Por favor, preencha o nome da cliente.');
            return;
        }

        if (!data || !semana || !hora) {
            alert('Por favor, preencha os campos de data, dia da semana e hora.');
            return;
        }

        if (!mensagemTemplate) {
            alert('Por favor, selecione uma mensagem para ser enviada.');
            return;
        }

        let mensagemFinal = mensagemTemplate
            .replace(/@nome/g, nome)
            .replace(/@data/g, data)
            .replace(/@semana/g, semana)
            .replace(/@hora/g, hora);

        const link = `https://wa.me/${telefone}?text=${encodeURIComponent(mensagemFinal)}`;

        window.open(link, '_blank');
    }

    if (e.target.classList.contains('limpar-btn')) {
        const linha = e.target.closest('tr');
        linha.querySelectorAll('input').forEach(input => input.value = '');
        linha.querySelector('select').value = '';
    }
});

// Formatação automática de hora HH:MM
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('hora')) {
        let input = e.target;
        let value = input.value.replace(/\D/g, ''); // Remove tudo que não é dígito
        
        if (value.length > 4) value = value.slice(0, 4); // Limita a 4 números
        
        if (value.length > 2) {
            value = value.slice(0, 2) + ':' + value.slice(2);
        }
        
        input.value = value;
    }
});

// Formatação automática de telefone +351 999 999 999
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('telefone')) {
        let input = e.target;
        let value = input.value.replace(/\D/g, ''); // Remove tudo que não é dígito
        
        if (value.length > 12) value = value.slice(0, 12); // Limita a 12 números (3 país + 9 número)
        
        let formatted = "";
        if (value.length > 0) formatted = "+" + value.slice(0, 3);
        if (value.length > 3) formatted += " " + value.slice(3, 6);
        if (value.length > 6) formatted += " " + value.slice(6, 9);
        if (value.length > 9) formatted += " " + value.slice(9, 12);
        
        input.value = formatted;
    }
});

// Formatação automática de data DD/MM
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('data')) {
        let input = e.target;
        let value = input.value.replace(/\D/g, ''); // Remove tudo que não é dígito
        
        if (value.length > 4) value = value.slice(0, 4); // Limita a 4 números
        
        if (value.length > 2) {
            value = value.slice(0, 2) + '/' + value.slice(2);
        }
        
        input.value = value;
    }
});

// Funções de Drag and Drop (Arrastar e Soltar)
let draggedIndex = null;

function dragStart(event, index) {
    draggedIndex = index;
    event.dataTransfer.effectAllowed = 'move';
    event.target.style.opacity = '0.5';
}

function dragOver(event) {
    event.preventDefault(); // Necessário para permitir o drop
    event.dataTransfer.dropEffect = 'move';
    return false;
}

function dragEnd(event) {
    event.target.style.opacity = '1';
    draggedIndex = null;
}

function drop(event, targetIndex) {
    event.stopPropagation();
    event.preventDefault();
    
    if (draggedIndex !== null && draggedIndex !== targetIndex) {
        const itemMoved = templates.splice(draggedIndex, 1)[0];
        templates.splice(targetIndex, 0, itemMoved);
        
        localStorage.setItem('whatsapp_templates', JSON.stringify(templates));
        renderTemplates();
    }
    return false;
}

</script>

{% endblock %}