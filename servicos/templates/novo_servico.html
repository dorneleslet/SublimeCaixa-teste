{% extends "base.html" %}
{% load static %}

{% block head %}
    <link rel="stylesheet" href="{% static 'clientes/css/clientes.css' %}">
{% endblock %}

{% block dashboard %}
<div class="container">
    <div class="row">
        <div onclick="exibir_form('1')" class="col-md card-dashboard">
            <p class="text-card">Novo serviço</p>
        </div>

        <div onclick="exibir_form('2')" class="col-md card-dashboard">
            <p class="text-card">Editar serviços</p>
        </div>
    </div>

     

     <!-- Formulário de cadastro de serviço -->

    <div id="adicionar-servico" class="adicionar-cliente" style="display: none;">
        <form method="POST" action="{% url 'novo_servico' %}">
        {% csrf_token %}
            <hr>
            <div class="row">
                <div class="col-md">
                    <label for="nome">Nome do Serviço:<span style="color: red;">*</span></label>
                    <input data-test="servico-cadastro" type="text" class="form-control" placeholder="Nome do serviço" name="nome" maxlength="50" required>
                </div>
            
                <div class="col-md">
                    <label for="preco">Preço:<span style="color: red;">*</span></label>
                    <input data-test="preco-cadastro" type="text" id="preco" class="form-control" placeholder="0,01" min="0" maxlength="7" name="preco" required>
                    <div class="invalid-feedback" id="erro-preco" style="color: red;"></div>
                    

                </div>
                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        const precoInput = document.getElementById('preco');

                        precoInput.addEventListener('input', function () {
                            let valor = precoInput.value.replace(/\D/g, ''); // só aceita números

                            if (!valor) {
                                precoInput.value = '';
                                return;
                            }

                            // limita o tamanho para evitar numeros gigantes
                            if (valor.length > 7) { // até 99999,99
                                valor = valor.slice(0, 7);
                            }

                            let parteInteira = '';
                            let parteDecimal = '';

                            if(valor.length <= 2) {
                                // menos de 3 digitos > só inteiro, sem virgula
                                precoInput.value = valor;
                                return;
                            } else {
                                // 3 ou mais digitos > separa os dois ultimos como decimais
                                parteInteira = valor.slice(0, -2);
                                parteDecimal = valor.slice(-2);
                            }

                            // adiciona separador de milhar
                            parteInteira = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');

                            precoInput.value = parteInteira + ',' + parteDecimal;
                        });
                        // bloqueia letras coladas
                        precoInput.addEventListener('keypress', function(e) {
                            if(!/\d/.test(e.key)) {
                                e.preventDefault();
                            }
                        });
                    });
                </script>
            </div>

            <hr style="background-color:gray;"> 
            <br>
            <input data-test="botao-cadastro" type="submit" id="btn-gravar" value="Cadastrar" class="btn btn-success">
            <br><br>
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-success" id="mensagem-sucesso">{{ message }}</div>
                {% endfor %}
            {% endif %}
        </form>

        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const form = document.querySelector("form");
                const btn = document.getElementById("btn-gravar");

                form.addEventListener("submit", function(event){
                    //Muda texto e desativa botão
                    btn.disabled = true;
                    const originalText = btn.value;
                    btn.value = "Gravando...";

                    //Espera 3 segundos antes de permitir clique novamente
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.value = originalText;
                    }, 3000);
                });

                //Mensagem de sucesso desaparece após 2 segundos
                const msg = document.getElementById("mensagem-sucesso");
                if (msg) {
                    setTimeout(() => {
                        msg.style.display = "none";
                    }, 2000);
                }
            });
        </script>    
        <br>

        {% if mensagem %}
        <div class="alert alert-success" id="mensagem-sucesso">{{ mensagem }}</div>
        {% endif %} 



    </div>
    <!-- Formulário de atualização de serviço -->
     <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
     <div id="att_servico" style="display: none;">
        
        <!-- <hr> -->
        <!-- CSS para alinhar os serviços à esquerda <<<< -->
         <style>
            #lista-servicos .list-group-item {
                text-align: left !important;
                justify-content: flex-start;
            }
         </style>

         <p></p> <!-- BARRA DE PESQUISA -->
         <input type="text" id="search-bar-servico" class="form-control mb-3" placeholder="Procurar serviço..." oninput="filtrarServicos()">
         <!-- LISTA DE SERVIÇOS -->
         <div id="lista-servicos" class="list-group list-group-flush">
            {% for servico in servicos %}
            <button id="servico-{{ servico.id }}" type="button" class="list-group-item w-100 text-start" onclick="dados_servico('{{ servico.id }}')">
                {{ servico.nome }} • {{ servico.preco|floatformat:2|cut:'.' }}€
            </button>
            {% endfor %}
         </div>


         <!-- FORMULÁRIO DE EDIÇÃO -->
        <div id="form-att-servico" style="display: none;"> 
            <button onclick="voltarLista()" class="btn btn-secondary mb-3">← Voltar para lista de serviços</button>
            <hr>
            <input type="hidden" id="id_servico">
            <label for="nome">Nome do Serviço:<span style="color: red;">*</span></label>
            <input id="nome" type="text" class="form-control" maxlength="50" required>
            <br>
            <label for="preco">Preço:<span style="color: red;">*</span></label>
            <input id="preco-edit" type="text" step="0.01" min="0" maxlength="7" class="form-control" required>

            <hr style="background-color:gray;">
            <br>
            <input id="btn-salvar-servico" onclick="update_servico()" type="button" value="Salvar alterações" class="btn btn-success">
            <button id="btn-excluir-servico" class="btn btn-danger" onclick="excluirServico(document.getElementById('id_servico').value)">Excluir</button>

            <div id="mensagem-sucesso-servico" class="alert alert-success mt-3" role="alert" style="display: none;">
                <p>Dados alterados com sucesso!</p>
            </div>
        </div>
    </div>

    <div id="confirm-delete-modal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(252, 209, 209, 0.5);
        justify-content: center; align-items: center; z-index: 1000;"> <!--esse background rgba deixa o fundo esmaecido da cor que colocar, tava rgba(0,0,0,0.5)-->
        <div style="background: rgb(255, 255, 255); padding: 20px; border-radius: 8px; max-width: 320px; text-align: center; color: #333;">
            <p>Tem certeza que deseja excluir este serviço?</p>
            <button id="btn-confirm-delete" class="btn btn-danger">Apagar</button>
            <button id="btn-cancel-delete" class="btn btn-secondary">Cancelar</button>
        </div>

    </div>

<script src="{% static 'servicos/js/servicos.js' %}"></script>
{% endblock %}
